name: Build and Release

on:
  workflow_dispatch:
    inputs:
      mc_version:
        description: 'Minecraft version to build'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check version directory
      run: |
        MC_VERSION="${{ inputs.mc_version }}"
        if [ ! -d "versions/$MC_VERSION" ]; then
          echo "Version directory versions/$MC_VERSION does not exist"
          exit 1
        fi
    
    - name: Create or get release
      run: |
        MC_VERSION="${{ inputs.mc_version }}"
        # Check if release exists, create if not
        if ! gh release view "v$MC_VERSION" >/dev/null 2>&1; then
          gh release create "v$MC_VERSION" \
            --title "Minecraft $MC_VERSION Bot" \
            --notes "Automated bot build for Minecraft $MC_VERSION"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: bot
            asset_name: bot-linux-x64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: bot
            asset_name: bot-linux-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: bot.exe
            asset_name: bot-windows-x64.exe
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            artifact_name: bot.exe
            asset_name: bot-windows-arm64.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: bot
            asset_name: bot-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: bot
            asset_name: bot-macos-arm64
    
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Read rust toolchain
      id: toolchain
      run: echo "toolchain=$(cat "versions/${{ inputs.mc_version }}/rust-toolchain")" >> $GITHUB_OUTPUT
      shell: bash

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ steps.toolchain.outputs.toolchain }}
        targets: ${{ matrix.target }}
    
    - name: Setup cross-compilation (Linux ARM64)
      if: matrix.target == 'aarch64-unknown-linux-gnu'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu
        echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
    
    - name: Build
      run: |
        cd "versions/${{ inputs.mc_version }}"
        
        # Build with the specified target
        cargo build --release --target ${{ matrix.target }}
        
        # Copy the built binary to workspace root
        cp "target/${{ matrix.target }}/release/${{ matrix.artifact_name }}" "../../${{ matrix.asset_name }}"
      shell: bash
    
    - name: Upload to release
      run: gh release upload "v${{ inputs.mc_version }}" "${{ matrix.asset_name }}" --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: ${{ matrix.asset_name }}
